version: 2.1

# https://circleci.com/docs/reusing-config#using-the-parameters-declaration
commands: # a reusable commands with parameters 

  gcr-build-push:
    parameters:
      dir:
        default: "."
        type: string
      tag:
        default: "latest"
        type: string
      image:
        type: string
      registry:
        type: string
      repo:
        type: string
      api-key:
        type: string
      username:
        type: string
    steps:
      - docker/build:
          workspace-root: <<parameters.dir>>
          path: <<parameters.dir>>
          docker-context: <<parameters.dir>>
          image:  <<parameters.repo>>/<<parameters.image>> 
          tag: <<parameters.tag>>
      - docker/push:
          image: <<parameters.repo>>/<<parameters.image>>
          tag: <<parameters.tag>>
          username: <<parameters.username>>
          password: <<parameters.api-key>>

orbs:
  gcp-gcr: circleci/gcp-gcr@0.15.0
  go: circleci/go@1.7.1
jobs:
  build-eventual-agent:
    executor: 
      name: go/default
      tag: "1.18"
    steps:
      - checkout
      - run: 
          command: | 
            go mod tidy
            go build -o build/ cmd/eventual-agent/eventual-agent.go

  test-eventual-agent:
    executor: 
      name: go/default
      tag: "1.18"
    steps:
      - checkout
      - run: 
          command: | 
            go mod tidy
            go test -v ./...

  build-and-push-eventual-agent:
    executor: gcp-gcr/default
    steps:
      - checkout       
      - gcr-build-push:
          image: eventual-agent
          repo: ${DOCKER_REPO}
          username: ${DOCKER_USERNAME}
          registry: ${DOCKER_REGISTRY}
          api-key: ${DOCKER_API_KEY}

workflows:
  eventual-agent:
    jobs:

      - test-eventual-agent:
          filters:
            branches:
              only: 
                - master
                - release/* 

      - build-eventual-agent:
          filters:
            branches:
              only: 
                - master
                - release/*
          requires:
            - test-eventual-agent

      - hold:
          type: approval
          filters:
            branches:
              only: release/*
          requires:
            - test-eventual-agent

      - build-and-push-eventual-agent:
          context: docker-hub
          filters:
            branches:
              only: release/* 
          requires:
            - hold
